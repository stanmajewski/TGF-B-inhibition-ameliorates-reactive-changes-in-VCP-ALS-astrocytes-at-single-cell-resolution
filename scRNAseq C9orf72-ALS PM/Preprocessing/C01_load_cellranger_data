#!/usr/bin/env Rscript

################################################################################
# Script: C01_load_cellranger_data.R
# Description: Load Cell Ranger outputs, perform initial QC, and merge samples
# 
# This script:
#   1. Loads Cell Ranger QC metrics and creates summary plots
#   2. Loads count matrices from Cell Ranger H5 files
#   3. Creates individual Seurat objects for each sample
#   4. Merges samples into a unified dataset
#   5. Generates quality control plots for the merged dataset
#
# Inputs:
#   - data/metadata/sample_metadata.csv: Sample information and file paths
#   - Cell Ranger H5 output files specified in metadata
#
# Outputs:
#   - results/01_data_loading/cellranger_qc.csv: Cell Ranger QC metrics
#   - results/01_data_loading/cellranger_qc_barplots.pdf: QC visualizations
#   - results/01_data_loading/seurat_list.rda: Individual Seurat objects
#   - results/01_data_loading/merged_seurat.rda: Merged dataset
#   - results/01_data_loading/qc_plots.pdf: Seurat QC visualizations
################################################################################

# Load required libraries
suppressPackageStartupMessages({
  library(tidyverse)
  library(Seurat)
  library(patchwork)
})

# Initialize logging
cat("\n")
cat("========================================================================\n")
cat("C01: Load Cell Ranger Data\n")
cat("Started:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n")
cat("========================================================================\n\n")

# Set random seed for reproducibility
set.seed(1234)

# Define paths
project_dir <- getwd()
metadata_file <- "data/metadata/sample_metadata.csv"
output_dir <- "results/01_data_loading"

# Create output directory
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
  cat("Created output directory:", output_dir, "\n")
}

################################################################################
# Load Sample Metadata
################################################################################

cat("\n>>> Loading sample metadata...\n")

if (!file.exists(metadata_file)) {
  stop("Metadata file not found: ", metadata_file, 
       "\nPlease ensure sample_metadata.csv exists in data/metadata/")
}

sample_metadata <- read_csv(metadata_file, show_col_types = FALSE)
cat("Loaded metadata for", nrow(sample_metadata), "samples\n")

################################################################################
# Load and Plot Cell Ranger QC Metrics
################################################################################

cat("\n>>> Loading Cell Ranger QC metrics...\n")

cellranger_qc <- NULL

for (i in 1:nrow(sample_metadata)) {
  sample_name <- sample_metadata$sample[i]
  cat("  Loading QC for", sample_name, "(", i, "of", nrow(sample_metadata), ")\n")
  
  # Construct path to Cell Ranger metrics
  metrics_path <- file.path(
    sample_metadata$cellranger_path[i],
    "outs/metrics_summary.csv"
  )
  
  if (!file.exists(metrics_path)) {
    warning("Metrics file not found: ", metrics_path)
    next
  }
  
  # Load metrics and add sample information
  metrics <- read_csv(metrics_path, show_col_types = FALSE)
  metrics_with_sample <- bind_cols(
    tibble(sample = sample_name),
    metrics
  )
  
  cellranger_qc <- bind_rows(cellranger_qc, metrics_with_sample)
}

# Save Cell Ranger QC metrics
qc_output <- file.path(output_dir, "cellranger_qc.csv")
write_csv(cellranger_qc, qc_output)
cat("Saved Cell Ranger QC metrics to:", qc_output, "\n")

# Create QC plots
cat("\n>>> Creating Cell Ranger QC plots...\n")

qc_metrics <- c(
  "Estimated Number of Cells",
  "Mean Reads per Cell",
  "Median UMI Counts per Cell",
  "Median Genes per Cell",
  "Fraction Reads in Cells",
  "Reads Mapped Confidently to Genome",
  "Reads Mapped Confidently to Transcriptome"
)

qc_plots <- lapply(qc_metrics, function(metric) {
  plot_data <- cellranger_qc %>%
    select(sample, value = all_of(metric)) %>%
    mutate(value = as.numeric(str_remove(value, "%")))
  
  ggplot(plot_data, aes(x = sample, y = value)) +
    geom_col(fill = "steelblue") +
    theme_classic() +
    labs(title = metric, y = metric) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
})

# Save QC plots
qc_plot_file <- file.path(output_dir, "cellranger_qc_barplots.pdf")
pdf(qc_plot_file, width = 10, height = 5)
lapply(qc_plots, print)
dev.off()
cat("Saved QC plots to:", qc_plot_file, "\n")

################################################################################
# Load Count Data and Create Seurat Objects
################################################################################

cat("\n>>> Loading count data and creating Seurat objects...\n")

seurat_list <- list()

for (i in 1:nrow(sample_metadata)) {
  sample_name <- sample_metadata$sample[i]
  cat("\n  Processing sample:", sample_name, "(", i, "of", nrow(sample_metadata), ")\n")
  
  # Get H5 file path
  h5_path <- sample_metadata$h5_path[i]
  
  if (!file.exists(h5_path)) {
    warning("H5 file not found: ", h5_path)
    next
  }
  
  # Load count matrix
  cat("    Loading count matrix...\n")
  counts <- Read10X_h5(h5_path)
  
  # Create Seurat object
  cat("    Creating Seurat object...\n")
  seurat_obj <- CreateSeuratObject(
    counts = counts,
    assay = "RNA",
    project = sample_name
  )
  
  # Add sample metadata
  for (col in colnames(sample_metadata)) {
    seurat_obj[[col]] <- sample_metadata[[col]][i]
  }
  
  # Calculate mitochondrial percentage
  mt_genes <- rownames(seurat_obj)[grepl("^MT-", rownames(seurat_obj))]
  seurat_obj[["percent_mt"]] <- PercentageFeatureSet(
    seurat_obj,
    features = mt_genes,
    assay = "RNA"
  )
  
  # Rename cells to ensure unique identifiers
  seurat_obj <- RenameCells(
    object = seurat_obj,
    add.cell.id = sample_name
  )
  
  seurat_list[[sample_name]] <- seurat_obj
  cat("    Completed. Cells:", ncol(seurat_obj), "\n")
}

# Save individual Seurat objects
cat("\n>>> Saving individual Seurat objects...\n")
seurat_list_file <- file.path(output_dir, "seurat_list.rda")
save(seurat_list, file = seurat_list_file)
cat("Saved to:", seurat_list_file, "\n")

# Garbage collection
gc(verbose = FALSE, full = TRUE)

################################################################################
# Merge Seurat Objects
################################################################################

cat("\n>>> Merging Seurat objects...\n")

merged_seurat <- merge(
  x = seurat_list[[1]],
  y = seurat_list[-1],
  merge.data = TRUE
)

cat("Merged dataset created. Total cells:", ncol(merged_seurat), "\n")

# Clear individual objects to free memory
rm(seurat_list)
gc(verbose = FALSE, full = TRUE)

# Save merged object
merged_file <- file.path(output_dir, "merged_seurat.rda")
save(merged_seurat, file = merged_file)
cat("Saved merged dataset to:", merged_file, "\n")

################################################################################
# Generate QC Plots for Merged Dataset
################################################################################

cat("\n>>> Generating QC plots for merged dataset...\n")

# Subsample for plotting if dataset is large
if (ncol(merged_seurat) > 50000) {
  cat("Dataset is large (", ncol(merged_seurat), "cells). Subsampling to 50,000 for plotting.\n")
  plot_seurat <- merged_seurat[, sample(colnames(merged_seurat), 50000)]
} else {
  plot_seurat <- merged_seurat
}

# Create QC violin plots
qc_plots <- list()

qc_plots[["nCount_RNA_full"]] <- VlnPlot(
  plot_seurat,
  features = "nCount_RNA",
  group.by = "sample",
  pt.size = 0.01
) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  NoLegend() +
  ylim(0, 50000) +
  labs(title = "Total UMI Counts (max 50k)")

qc_plots[["nCount_RNA_zoom"]] <- VlnPlot(
  plot_seurat,
  features = "nCount_RNA",
  group.by = "sample",
  pt.size = 0.01
) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  NoLegend() +
  ylim(0, 3000) +
  labs(title = "Total UMI Counts (max 3k)")

qc_plots[["nFeature_RNA"]] <- VlnPlot(
  plot_seurat,
  features = "nFeature_RNA",
  group.by = "sample",
  pt.size = 0.01
) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  NoLegend() +
  labs(title = "Number of Genes Detected")

qc_plots[["percent_mt_full"]] <- VlnPlot(
  plot_seurat,
  features = "percent_mt",
  group.by = "sample",
  pt.size = 0.01
) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  NoLegend() +
  labs(title = "Mitochondrial Percentage")

qc_plots[["percent_mt_zoom"]] <- VlnPlot(
  plot_seurat,
  features = "percent_mt",
  group.by = "sample",
  pt.size = 0.01
) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  NoLegend() +
  ylim(0, 5) +
  labs(title = "Mitochondrial Percentage (max 5%)")

# Save QC plots
qc_plot_file <- file.path(output_dir, "qc_plots.pdf")
pdf(qc_plot_file, width = 10, height = 6)
lapply(qc_plots, print)
dev.off()
cat("Saved QC plots to:", qc_plot_file, "\n")

################################################################################
# Completion Summary
################################################################################

cat("\n")
cat("========================================================================\n")
cat("C01: Data Loading Complete\n")
cat("Completed:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n")
cat("========================================================================\n")
cat("\nSummary:\n")
cat("  Samples processed:", length(unique(merged_seurat$sample)), "\n")
cat("  Total cells:", ncol(merged_seurat), "\n")
cat("  Total genes:", nrow(merged_seurat), "\n")
cat("\nOutput files:\n")
cat("  -", qc_output, "\n")
cat("  -", qc_plot_file, "\n")
cat("  -", seurat_list_file, "\n")
cat("  -", merged_file, "\n")
cat("========================================================================\n\n")
